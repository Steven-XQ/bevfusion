import numpy as np
import matplotlib.pyplot as plt
import matplotlib.gridspec as gridspec
import seaborn as sns

routing_probs = np.array([[0.2160, 0.2611, 0.3102, 0.2127],
        [0.2400, 0.2492, 0.2804, 0.2305],
        [0.2108, 0.2581, 0.3170, 0.2140],
        [0.2929, 0.2327, 0.2246, 0.2498],
        [0.2219, 0.2569, 0.3032, 0.2181],
        [0.2859, 0.2329, 0.2287, 0.2525],
        [0.2923, 0.2317, 0.2229, 0.2531],
        [0.2944, 0.2326, 0.2232, 0.2498],
        [0.3138, 0.2261, 0.2030, 0.2571],
        [0.2381, 0.2514, 0.2844, 0.2261],
        [0.3103, 0.2282, 0.2078, 0.2537],
        [0.2993, 0.2311, 0.2180, 0.2515],
        [0.2705, 0.2373, 0.2446, 0.2476],
        [0.3040, 0.2243, 0.2103, 0.2614],
        [0.2293, 0.2515, 0.2938, 0.2254],
        [0.2310, 0.2548, 0.2935, 0.2208],
        [0.2557, 0.2433, 0.2633, 0.2377],
        [0.2613, 0.2386, 0.2560, 0.2441],
        [0.2752, 0.2364, 0.2402, 0.2482],
        [0.2297, 0.2548, 0.2945, 0.2210],
        [0.3038, 0.2274, 0.2123, 0.2565],
        [0.2956, 0.2302, 0.2204, 0.2537],
        [0.2755, 0.2352, 0.2383, 0.2511],
        [0.2989, 0.2278, 0.2172, 0.2561]])

selection = np.argmax(routing_probs, axis=1)
selection_map = np.zeros_like(routing_probs)
selection_map[np.arange(routing_probs.shape[0]), selection] = 1

plt.figure(figsize=(10, 8))
gs = gridspec.GridSpec(1, 2)

ax0 = plt.subplot(gs[0, 0])
sns.heatmap(routing_probs, cmap='viridis', cbar=True, 
            xticklabels=[f'Expert {i}' for i in range(routing_probs.shape[1])],
            yticklabels=False)
ax0.set_title('Routing Probabilities')
ax0.set_ylabel('Samples')

ax1 = plt.subplot(gs[0, 1])
sns.heatmap(selection_map, cmap='Greys', cbar=False, 
            xticklabels=[f'Expert {i}' for i in range(routing_probs.shape[1])],
            yticklabels=False)
ax1.set_title('Expert Selection')

plt.tight_layout()
plt.savefig('/bevfusion/tools/routing_probs_heatmap.png')



# [[0.2386, 0.2543, 0.3047, 0.2024],
#         [0.2432, 0.2522, 0.2992, 0.2054],
#         [0.2303, 0.2545, 0.3137, 0.2014],
#         [0.2396, 0.2527, 0.3051, 0.2026],
#         [0.2427, 0.2522, 0.3019, 0.2032],
#         [0.2416, 0.2529, 0.3013, 0.2043],
#         [0.2240, 0.2555, 0.3194, 0.2011],
#         [0.2211, 0.2572, 0.3242, 0.1975],
#         [0.2060, 0.2587, 0.3424, 0.1929],
#         [0.2088, 0.2563, 0.3399, 0.1950],
#         [0.2035, 0.2545, 0.3460, 0.1961],
#         [0.2113, 0.2530, 0.3362, 0.1994],
#         [0.2309, 0.2549, 0.3130, 0.2012],
#         [0.2566, 0.2486, 0.2852, 0.2096],
#         [0.2275, 0.2552, 0.3179, 0.1994],
#         [0.2256, 0.2576, 0.3189, 0.1979],
#         [0.2333, 0.2548, 0.3102, 0.2018],
#         [0.2477, 0.2506, 0.2941, 0.2077],
#         [0.2306, 0.2515, 0.3115, 0.2064],
#         [0.2341, 0.2509, 0.3087, 0.2063],
#         [0.2653, 0.2453, 0.2755, 0.2140],
#         [0.2250, 0.2544, 0.3190, 0.2017],
#         [0.2628, 0.2466, 0.2766, 0.2140],
#         [0.2478, 0.2501, 0.2935, 0.2086]]

# [[0.2762, 0.2515, 0.2342, 0.2381],
#         [0.3591, 0.2941, 0.2120, 0.1347],
#         [0.1685, 0.1883, 0.2621, 0.3810],
#         [0.2386, 0.2261, 0.2390, 0.2962],
#         [0.2066, 0.2156, 0.2473, 0.3305],
#         [0.3585, 0.2924, 0.2063, 0.1428],
#         [0.1892, 0.2023, 0.2559, 0.3526],
#         [0.2623, 0.2412, 0.2341, 0.2625],
#         [0.1780, 0.1985, 0.2605, 0.3629],
#         [0.2282, 0.2276, 0.2487, 0.2954],
#         [0.2343, 0.2417, 0.2529, 0.2712],
#         [0.2991, 0.2665, 0.2300, 0.2044],
#         [0.1512, 0.1919, 0.2894, 0.3675],
#         [0.3184, 0.2850, 0.2303, 0.1663],
#         [0.1547, 0.1905, 0.2826, 0.3722],
#         [0.1715, 0.1965, 0.2648, 0.3672],
#         [0.1901, 0.2038, 0.2552, 0.3509],
#         [0.2740, 0.2512, 0.2350, 0.2397],
#         [0.1841, 0.1950, 0.2561, 0.3649],
#         [0.1972, 0.2014, 0.2454, 0.3560],
#         [0.1697, 0.1941, 0.2671, 0.3690],
#         [0.1777, 0.1998, 0.2579, 0.3646],
#         [0.1808, 0.1941, 0.2560, 0.3691],
#         [0.1995, 0.2066, 0.2421, 0.3518]]

# [[0.2160, 0.2611, 0.3102, 0.2127],
#         [0.2400, 0.2492, 0.2804, 0.2305],
#         [0.2108, 0.2581, 0.3170, 0.2140],
#         [0.2929, 0.2327, 0.2246, 0.2498],
#         [0.2219, 0.2569, 0.3032, 0.2181],
#         [0.2859, 0.2329, 0.2287, 0.2525],
#         [0.2923, 0.2317, 0.2229, 0.2531],
#         [0.2944, 0.2326, 0.2232, 0.2498],
#         [0.3138, 0.2261, 0.2030, 0.2571],
#         [0.2381, 0.2514, 0.2844, 0.2261],
#         [0.3103, 0.2282, 0.2078, 0.2537],
#         [0.2993, 0.2311, 0.2180, 0.2515],
#         [0.2705, 0.2373, 0.2446, 0.2476],
#         [0.3040, 0.2243, 0.2103, 0.2614],
#         [0.2293, 0.2515, 0.2938, 0.2254],
#         [0.2310, 0.2548, 0.2935, 0.2208],
#         [0.2557, 0.2433, 0.2633, 0.2377],
#         [0.2613, 0.2386, 0.2560, 0.2441],
#         [0.2752, 0.2364, 0.2402, 0.2482],
#         [0.2297, 0.2548, 0.2945, 0.2210],
#         [0.3038, 0.2274, 0.2123, 0.2565],
#         [0.2956, 0.2302, 0.2204, 0.2537],
#         [0.2755, 0.2352, 0.2383, 0.2511],
#         [0.2989, 0.2278, 0.2172, 0.2561]]
